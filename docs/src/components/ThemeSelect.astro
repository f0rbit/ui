---
const themes = [
	{ label: "Light", value: "light" },
	{ label: "Dark", value: "dark" },
	{ label: "Auto", value: "auto" },
];
---

<starlight-theme-select>
	<div class="dropdown">
		<button class="btn btn-primary theme-trigger" aria-label="Select theme">
			<svg style={{"margin-top": "-1px"}} class="chevron" viewBox="0 0 24 24" width="1em" height="1em" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="m9 18 6-6-6-6" />
			</svg>
			<span class="theme-label">Auto</span>
		</button>
		<div class="dropdown-menu" hidden>
			{themes.map((theme) => (
				<button class="dropdown-item" data-theme-value={theme.value}>
					{theme.label}
				</button>
			))}
		</div>
	</div>
</starlight-theme-select>

<script is:inline>
	StarlightThemeProvider.updatePickers();
</script>

<script>
	declare const StarlightThemeProvider: {
		updatePickers: (theme?: string) => void;
	};

	type Theme = "auto" | "dark" | "light";

	const storageKey = "starlight-theme";

	const parseTheme = (theme: unknown): Theme =>
		theme === "auto" || theme === "dark" || theme === "light" ? theme : "auto";

	const loadTheme = (): Theme =>
		parseTheme(typeof localStorage !== "undefined" && localStorage.getItem(storageKey));

	const storeTheme = (theme: Theme): void => {
		if (typeof localStorage !== "undefined") {
			localStorage.setItem(storageKey, theme === "light" || theme === "dark" ? theme : "");
		}
	};

	const getPreferredColorScheme = (): Theme =>
		matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark";

	const themeLabels: Record<Theme, string> = {
		light: "Light",
		dark: "Dark",
		auto: "Auto",
	};

	const onThemeChange = (theme: Theme): void => {
		StarlightThemeProvider.updatePickers(theme);
		document.documentElement.dataset.theme = theme === "auto" ? getPreferredColorScheme() : theme;
		storeTheme(theme);
	};

	matchMedia("(prefers-color-scheme: light)").addEventListener("change", () => {
		if (loadTheme() === "auto") onThemeChange("auto");
	});

	class StarlightThemeSelect extends HTMLElement {
		private dropdown: HTMLElement | null = null;
		private trigger: HTMLElement | null = null;
		private menu: HTMLElement | null = null;
		private chevron: HTMLElement | null = null;
		private label: HTMLElement | null = null;
		private isOpen = false;

		constructor() {
			super();
			this.dropdown = this.querySelector(".dropdown");
			this.trigger = this.querySelector(".theme-trigger");
			this.menu = this.querySelector(".dropdown-menu");
			this.chevron = this.querySelector(".chevron");
			this.label = this.querySelector(".theme-label");

			this.initTheme();
			this.bindEvents();
		}

		private initTheme(): void {
			const theme = loadTheme();
			onThemeChange(theme);
			this.updateLabel(theme);
			this.updateActiveItem(theme);
		}

		private bindEvents(): void {
			this.trigger?.addEventListener("click", (e) => {
				e.stopPropagation();
				this.toggle();
			});

			this.menu?.querySelectorAll(".dropdown-item").forEach((item) => {
				item.addEventListener("click", () => {
					const value = (item as HTMLElement).dataset.themeValue as Theme;
					onThemeChange(value);
					this.updateLabel(value);
					this.updateActiveItem(value);
					this.close();
				});
			});

			document.addEventListener("click", (e) => {
				if (!this.dropdown?.contains(e.target as Node)) {
					this.close();
				}
			});

			document.addEventListener("keydown", (e) => {
				if (e.key === "Escape" && this.isOpen) {
					this.close();
				}
			});
		}

		private toggle(): void {
			this.isOpen ? this.close() : this.open();
		}

		private open(): void {
			this.isOpen = true;
			this.menu?.removeAttribute("hidden");
			this.chevron?.classList.add("chevron-expanded");
		}

		private close(): void {
			this.isOpen = false;
			this.menu?.setAttribute("hidden", "");
			this.chevron?.classList.remove("chevron-expanded");
		}

		private updateLabel(theme: Theme): void {
			if (this.label) {
				this.label.textContent = themeLabels[theme];
			}
		}

		private updateActiveItem(theme: Theme): void {
			this.menu?.querySelectorAll(".dropdown-item").forEach((item) => {
				const value = (item as HTMLElement).dataset.themeValue;
				item.classList.toggle("dropdown-item-active", value === theme);
			});
		}
	}

	customElements.define("starlight-theme-select", StarlightThemeSelect);
</script>

<style>
	.theme-label {
		flex: 1;
		text-align: center;
	}

	.chevron {
		transition: transform var(--transition);
		color: var(--fg-faint);
	}

	.chevron-expanded {
		transform: rotate(90deg);
	}
</style>
